#!/bin/bash
#
# port átengedés ssh tunnel-en
#

localdir=`dirname $0`
. $localdir/webcl-config

list=`ls webcl-*$PID_EXT 2>>/dev/null`
if [ ! -z $list ]; then
	for i in $list; do
		pid=`cat $i`
		run=`ps -A | grep $pid | awk {'print $1'}`
		#echo "PID: $pid -> $run"
		bifs=$IFS
		IFS="-"
		x=( $i )
		y=${x[1]}
		IFS="."
		x=( $y )
		y=${x[0]}
		IFS=$bifs
		#echo $y
		if [ -z "$run" ]; then
			$localdir/webcl-remote-server $y
		fi
		for x in ${!TUN_REMOTE_PORTS[@]}; do
			if [ "${TUN_REMOTE_PORTS[$x]}" == "$y" ]; then
				#echo $y
				#popen=`nmap $TUN_SERVER -p ${TUN_SERVER_BRIDGE_PORTS[$x]} | grep closed`
				#echo $popen
				popen=""
				if [ -z "$popen" ]; then
					rm $i 2>/dev/null
					kill -9 $pid 2>/dev/null
					$localdir/webcl-remote-server $y
				fi
			fi
		done
	done
fi

#
